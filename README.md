## å†™åœ¨å‰é¢

ä¸ºä»€ä¹ˆè¦è‡ªå·±æ­å»ºï¼Ÿ

## è·å– App Store åº”ç”¨å†…è´­ä¿¡æ¯æ–¹æ³•å¯¹æ¯”

| ç‰¹æ€§              | æ–¹æ³•ä¸€ï¼šè‹¹æœå®˜æ–¹æ¥å£                     | æ–¹æ³•äºŒï¼šå¼€æº Node.js åº“ (å¦‚ app-store-scraper) | æ–¹æ³•ä¸‰ï¼šç›´æ¥çˆ¬å– App Store ç½‘é¡µ            | æ–¹æ³•å››ï¼šç¬¬ä¸‰æ–¹çˆ¬è™« API æœåŠ¡            |
| :---------------- | :--------------------------------------- | :--------------------------------------------- | :----------------------------------------- | :------------------------------------- |
| **æ˜¯å¦æ¨è**      | **å¦**                                   | **éƒ¨åˆ†æ¨è (éœ€è‡ªè¡Œæ‰©å±•)**                      | **æ˜¯**                                     | **é…Œæƒ…ä½¿ç”¨**                           |
| **è·å–å†…è´­è¯¦æƒ…**  | å¦ (æœ€å¤šçŸ¥é“â€œæ˜¯å¦å«å†…è´­â€æ ‡å¿—)            | å¦ (é»˜è®¤ä¸æä¾›ï¼Œéœ€äºŒæ¬¡å¼€å‘)                    | æ˜¯ (å¯ä» HTML ä¸­æå–)                      | å¯èƒ½ (å–å†³äºå…·ä½“æœåŠ¡åŠå…¶æŠ“å–æ·±åº¦)      |
| **æˆæœ¬**          | å…è´¹                                     | å…è´¹ (å¼€æºåº“)                                  | å…è´¹ (è‡ªå»ºçˆ¬è™«)                            | æœ‰é™å…è´¹é¢åº¦ï¼Œè¶…å‡ºéœ€ä»˜è´¹               |
| **å®ç°å¤æ‚åº¦**    | ä½ (ç®€å• HTTP è¯·æ±‚)                      | ä½ (ä½¿ç”¨åº“å‡½æ•°)                                | ä¸­ (éœ€å¤„ç†è¯·æ±‚ã€è§£æ HTMLã€åçˆ¬)           | éå¸¸ä½ (è°ƒç”¨ç°æˆ API)                  |
| **ä¸»è¦ä¼˜ç‚¹**      | å®˜æ–¹æ¥å£ç¨³å®šã€å…è´¹ã€ä½¿ç”¨ç®€å•             | å…è´¹å¼€æºã€å°è£…å¸¸ç”¨åŠŸèƒ½ã€å†…ç½®é€Ÿç‡é™åˆ¶           | å¯è·å–å†…è´­è¯¦æƒ…ã€å…è´¹ã€å®Œå…¨å¯æ§             | å®ç°ç®€å•ã€å¤„ç†åçˆ¬ã€ç»“æœç»“æ„åŒ–         |
| **ä¸»è¦ç¼ºç‚¹**      | æ— æ³•è·å–å†…è´­åˆ—è¡¨ï¼ŒConnect API é™åˆ¶å¤š     | é»˜è®¤æ— æ³•è·å–å†…è´­ã€éœ€è‡ªè¡Œæ‰©å±•çˆ¬è™«åŠŸèƒ½           | éœ€å¤„ç†åçˆ¬ç­–ç•¥ (å¯èƒ½å° IP)ã€é¡µé¢å˜åŠ¨éœ€ç»´æŠ¤ | å…è´¹é¢åº¦æœ‰é™ã€ä¸é€‚åˆé«˜é¢‘ã€ä¾èµ–ç¬¬ä¸‰æ–¹   |
| **å…³é”®æŠ€æœ¯/å·¥å…·** | iTunes Search API, App Store Connect API | `app-store-scraper` ç­‰ Node.js åº“              | `axios`/`got`, `cheerio`, (å¯èƒ½éœ€ä»£ç† IP)  | Apify, SerpApi, SearchAPI ç­‰ç¬¬ä¸‰æ–¹æœåŠ¡ |
| **ç»´æŠ¤æˆæœ¬**      | ä½                                       | ä¸­ (åº“æ›´æ–° + è‡ªè¡Œæ‰©å±•éƒ¨åˆ†)                     | é«˜ (åº”å¯¹åçˆ¬å’Œé¡µé¢ç»“æ„å˜åŒ–)                | ä½ (ç”±æœåŠ¡å•†å¤„ç†)                      |

---

### ç»¼åˆå»ºè®®

ç»¼åˆæ¥çœ‹ï¼Œ**æ–¹æ³•ä¸‰ï¼šç›´æ¥è‡ªè¡Œçˆ¬å– App Store ç½‘é¡µ** æœ€èƒ½æ»¡è¶³ â€œNode.js å®ç°ã€å…è´¹ä½¿ç”¨ã€é¢‘ç¹æŸ¥è¯¢å†…è´­è¯¦æƒ…â€ çš„æ ¸å¿ƒéœ€æ±‚ã€‚è™½ç„¶éœ€è¦è‡ªè¡Œå¤„ç†åçˆ¬è™«ç­–ç•¥ï¼ˆå¦‚æ§åˆ¶è¯·æ±‚é¢‘ç‡ã€æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸ºï¼‰ï¼Œå¹¶ä¸”è¦ç»´æŠ¤åº”å¯¹ç½‘é¡µç»“æ„å˜åŒ–çš„ä»£ç ï¼Œä½†è¿™æ˜¯å”¯ä¸€èƒ½å®Œå…¨å…è´¹ã€è‡ªä¸»æ§åˆ¶å¹¶ç¡®å®è·å–åˆ°å†…è´­é¡¹ç›®åˆ—è¡¨çš„æ–¹æ¡ˆã€‚

- **æ–¹æ³•äºŒ (å¼€æºåº“)** å¯ä½œä¸ºè·å–åº”ç”¨åŸºç¡€ä¿¡æ¯çš„è¾…åŠ©æ‰‹æ®µï¼Œä½†è·å–å†…è´­ä»éœ€ç»“åˆ **æ–¹æ³•ä¸‰** çš„çˆ¬è™«é€»è¾‘ã€‚
- **æ–¹æ³•å›› (ç¬¬ä¸‰æ–¹ API)** é€‚åˆä½é¢‘æˆ–æœ‰é¢„ç®—çš„åœºæ™¯ï¼Œå…¶å…è´¹é¢åº¦é€šå¸¸éš¾ä»¥æ”¯æ’‘é•¿æœŸã€é¢‘ç¹çš„æŸ¥è¯¢éœ€æ±‚ã€‚
- **æ–¹æ³•ä¸€ (å®˜æ–¹ API)** å› æ— æ³•æä¾›å†…è´­åˆ—è¡¨ï¼Œä¸æ»¡è¶³éœ€æ±‚ã€‚

å› æ­¤ï¼Œæ¨èåœ¨ Node.js ä¸­ **è‡ªè¡Œå®ç°çˆ¬è™« (æ–¹æ³•ä¸‰)**ï¼Œå¹¶è°¨æ…å¤„ç†åçˆ¬é—®é¢˜ï¼Œä»¥ç¨³å®šè·å–æ‰€éœ€çš„åº”ç”¨å†…è´­ä¿¡æ¯ã€‚

# æ–¹æ³•ä¸€ï¼šä¸€é”®éƒ¨ç½²

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/qww2014/publicBashList/refs/heads/main/deploy-fetchiape.sh)
```

# æ–¹æ³•äºŒï¼šé€æ­¥æ­å»º

## **ğŸ›  æ­¥éª¤ 1ï¼šæ­å»º VPS ç‰ˆ Puppeteer API æœåŠ¡**

### 1ã€**å‡†å¤‡ç¯å¢ƒ**

```bash
sudo apt update
sudo apt install -y nodejs npm
#æ³¨æ„1.1
sudo npm install -g pnpm
```

### 1.1ã€æŸ¥çœ‹ node ç‰ˆæœ¬ å¦‚æœé«˜äº 18 ç•¥è¿‡,ç›´æ¥ 1.2ï¼Œå¦åˆ™ï¼šï¼ˆå»ºè®®å®‰è£…æœ€æ–°ï¼‰

```bash
sudo npm install -g n
sudo n lts

n #é€‰æ‹©æ›´æ¢nodeç‰ˆæœ¬
node -v #å‡çº§å®Œä¹‹åï¼ŒæŸ¥çœ‹ä¸€ä¸‹ç‰ˆæœ¬ç¡®è®¤

```

å¦‚æœä¸æ˜¯æœ€æ–°ï¼Œåˆ‡æ¢ä¸è¿‡æ¥

```
hash -r #åˆ·æ–°ä½ çš„ shell ä¸­çš„å‘½ä»¤ç¼“å­˜ï¼Œè®©å®ƒé‡æ–°æ‰¾ node çš„ä½ç½®ï¼
```

### 2ã€**å®‰è£… Puppeteer å’Œ Express dotenv**

```bash
mkdir -p /opt/fetchIAP-server
cd /opt/fetchIAP-server
pnpm init
pnpm add puppeteer express dotenv cors

# æœ¬åœ°è¿è¡Œæ—¶ï¼Œä¸ç”¨å®‰è£…ä¸€ä¸‹
npm add pm2 -g
# å®‰è£…æµè§ˆå™¨
npx puppeteer browsers install chrome # X86
apt install -y chromium # arm
```

### 3ã€**åˆ›å»º server.js**

```bash
nano server.js
```

```javascript
/*
 * @Author: Lao Qiao
 * @Date: 2025-04-28
 * @FilePath: /fetchIAP-multi/server.js
 * å°ç¾å‡ºå“ï¼Œå¿…å±ç²¾å“ âœ¨
 */

const express = require('express');
const cors = require('cors');
const { fetchIAP } = require('./fetchIAP');

const app = express();
const port = 3000;
const TIMEOUT_PER_COUNTRY = 30000; // æ¯ä¸ªå›½å®¶è¶…æ—¶æ—¶é—´(ms)

// CORS é…ç½®é€‰é¡¹
const corsOptions = {
  origin: '*', // å…è®¸æ‰€æœ‰æ¥æºçš„è¯·æ±‚
  methods: ['GET', 'POST'], // å…è®¸çš„ HTTP æ–¹æ³•
  allowedHeaders: ['Content-Type', 'Authorization'], // å…è®¸çš„è¯·æ±‚å¤´
  credentials: false, // ç”±äºä½¿ç”¨äº† origin: '*'ï¼Œcredentials å¿…é¡»è®¾ä¸º false
};

// å¯ç”¨ CORSï¼Œä½¿ç”¨é…ç½®é€‰é¡¹
app.use(cors(corsOptions));

app.use(express.json());

// å¥åº·æ£€æŸ¥æ¥å£
app.get('/', (req, res) => {
  res.send('âœ¨ FetchIAP Server æ­£å¸¸è¿è¡Œä¸­ï¼');
});

// å•å›½å®¶æŸ¥è¯¢ï¼Œé™„å¸¦è¶…æ—¶ä¿æŠ¤
const fetchIAPWithTimeout = (params, timeoutMs = 30000) => {
  return Promise.race([
    fetchIAP(params),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('æŠ“å–è¶…æ—¶')), timeoutMs)
    ),
  ]);
};

app.post('/iap', async (req, res) => {
  const { appId, countries = [], slug = '' } = req.body;

  if (!appId || !Array.isArray(countries) || countries.length === 0) {
    return res.status(400).json({
      success: false,
      error: 'è¯·æ±‚å¿…é¡»åŒ…å« appId å’Œ countries åˆ—è¡¨ï¼',
    });
  }

  const isValidCountryCode = (code) => /^[a-z]{2}$/i.test(code);

  const invalidCountries = countries.filter((c) => !isValidCountryCode(c));
  if (invalidCountries.length > 0) {
    return res.status(400).json({
      success: false,
      error: `å›½å®¶ä»£ç æ ¼å¼é”™è¯¯ï¼š${invalidCountries.join(', ')}`,
    });
  }
  const results = {};

  try {
    for (const country of countries) {
      console.log(`âœ¨ æŸ¥è¯¢ ${country.toUpperCase()}...`);

      try {
        const items = await fetchIAPWithTimeout(
          { appId, country, slug },
          TIMEOUT_PER_COUNTRY
        );
        results[country] = items;
      } catch (err) {
        console.error(`âš ï¸ æŸ¥è¯¢ ${country.toUpperCase()} å¤±è´¥ï¼š${err.message}`);
        results[country] = { error: err.message };
      }
    }

    res.json({ success: true, data: results });
  } catch (err) {
    console.error('âŒ æ€»ä½“æŸ¥è¯¢å¤±è´¥:', err);
    res
      .status(500)
      .json({ success: false, error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯', details: err.message });
  }
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(port, () => {
  console.log(`ğŸš€ FetchIAP Server å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ ${port}`);
});
```

```
ctrl + O
å›è½¦
ctrl + X
```

### 4ã€åˆ›å»º fetchIAP.js

```javascript
/*
 * @Author: Lao Qiao
 * @Date: 2025-04-28
 * å°ç¾å‡ºå“ï¼Œå¿…å±ç²¾å“ âœ¨
 */

const puppeteer = require('puppeteer');

const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

const purchaseLabelMap = {
  us: 'In-App Purchases',
  cn: 'App å†…è´­ä¹°é¡¹ç›®',
  jp: 'ã‚¢ãƒ—ãƒªå†…èª²é‡‘æœ‰ã‚Š',
  kr: 'ì•± ë‚´ êµ¬ì…',
  fr: 'Achats intÃ©grÃ©s',
  de: 'Inâ€‘Appâ€‘KÃ¤ufe',
  it: 'Acquisti In-App',
  es: 'Compras dentro de la app',
  ru: 'Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸',
};

async function autoScrollUntil(page, selector, timeout = 10000) {
  console.log(`ğŸ” å¼€å§‹è‡ªåŠ¨æ»šåŠ¨ï¼Œç­‰å¾…å‡ºç°å…ƒç´ : ${selector}`);
  const start = Date.now();
  while (Date.now() - start < timeout) {
    const found = await page.evaluate(
      (sel) => !!document.querySelector(sel),
      selector
    );
    if (found) {
      console.log(`âœ… æ‰¾åˆ°äº†ç›®æ ‡å…ƒç´ : ${selector}`);
      break;
    }
    await page.evaluate(() => window.scrollBy(0, window.innerHeight / 2));
    await sleep(100);
  }
}

async function fetchIAP({ appId, country = 'us', slug = '' }) {
  console.log(
    `ğŸš€ [${country.toUpperCase()}] å¼€å§‹æŠ“å–åº”ç”¨ID: ${appId}, Slug: ${slug}`
  );

  const url = slug
    ? `https://apps.apple.com/${country}/app/${slug}/id${appId}`
    : `https://apps.apple.com/${country}/app/id${appId}`;

  console.log(`ğŸŒ è®¿é—®URL: ${url}`);

  const browser = await puppeteer.launch({
    headless: 'new',
    executablePath: '/usr/bin/chromium', // æ³¨æ„å®é™…è·¯å¾„
    args: ['--no-sandbox', '--disable-setuid-sandbox'],
  });

  const page = await browser.newPage();

  try {
    console.log(`ğŸ› ï¸ è®¾ç½®Headerså’ŒUserAgent...`);
    await page.setExtraHTTPHeaders({ 'Accept-Language': 'en-US,en;q=0.9' });
    await page.setUserAgent(
      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36'
    );

    console.log(`â³ é¡µé¢åŠ è½½ä¸­...`);
    await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 });

    console.log(`ğŸ”„ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æ»šåŠ¨åŠ è½½å†…å®¹...`);
    await autoScrollUntil(page, 'dt.information-list__item__term');
    await sleep(500);

    const purchaseLabel =
      purchaseLabelMap[country.toLowerCase()] || 'In-App Purchases';
    console.log(`ğŸ›’ æœç´¢å†…è´­æ ‡é¢˜: ${purchaseLabel}`);

    const items = await page.evaluate((label) => {
      const sections = Array.from(
        document.querySelectorAll('dt.information-list__item__term')
      );
      let matchedSection = null;

      for (const dt of sections) {
        if (dt.textContent.trim() === label) {
          matchedSection = dt.closest('.information-list__item');
          break;
        }
      }

      if (!matchedSection) {
        console.log(`âŒ æœªæ‰¾åˆ°å†…è´­ä¿¡æ¯åŒºå—: ${label}`);
        return [];
      }

      const results = [];
      matchedSection
        .querySelectorAll('li.list-with-numbers__item')
        .forEach((li) => {
          const name = li
            .querySelector('.list-with-numbers__item__title')
            ?.textContent.trim();
          const price = li
            .querySelector('.list-with-numbers__item__price')
            ?.textContent.trim();
          if (name && price) results.push({ name, price });
        });
      console.log(`ğŸ“¦ å†…è´­ä¿¡æ¯æŠ“å–å®Œæˆ: å…± ${results.length} é¡¹`);
      return results;
    }, purchaseLabel);

    return items;
  } catch (err) {
    console.error(`âŒ [${country.toUpperCase()}] æŠ“å–è¿‡ç¨‹å‡ºé”™:`, err.message);
    throw err;
  } finally {
    console.log(`ğŸ§¹ å…³é—­æµè§ˆå™¨å®ä¾‹...`);
    await browser.close();
  }
}

module.exports = { fetchIAP };
```

### 5ã€**å¯åŠ¨æœåŠ¡å™¨**

```bash
# æœ¬å¼€å‘ç¯å¢ƒè¿è¡Œ
node server.js
# ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
pm2 start server.js --name fetchIAP-server
```

#### è®¾ç½®å¼€æœºè‡ªå¯ï¼š

```bash
pm2 save
pm2 startup
```

æœåŠ¡å™¨å°±èƒ½é€šè¿‡ï¼š

```
POST http://your-vps-ip:3000/iap
```

æ¥æŸ¥è¯¢å†…è´­äº†ï¼å†…è´­æŠ“å–åç«‹å³è¿”å› JSONï¼

# **ğŸ›  æ­¥éª¤ 2ï¼šéƒ¨ç½² Cloudflare Worker ä½œä¸º API ä»£ç†**

### 1ã€**ç™»å½• Cloudflare**

### 2ã€**åˆ›å»ºä¸€ä¸ªæ–°çš„ Worker**

```javascript
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const targetUrl = 'http://your-vps-ip:3000' + url.pathname; // æ³¨æ„ï¼VPSå…¬ç½‘IP

    const modifiedRequest = new Request(targetUrl, {
      method: request.method,
      headers: request.headers,
      body: request.body,
    });

    return fetch(modifiedRequest);
  },
};
```

âœ… è¿™ä¸ª Worker æ˜¯ä¸€ä¸ª**å…¨é€æ˜ä¸­ç»§**ï¼š

å®¢æˆ·ç«¯è®¿é—® Worker â” Worker æŠŠè¯·æ±‚ä¸­è½¬åˆ°ä½  VPS â” å†æŠŠç»“æœè¿”å›

## **ğŸ¯ æ•´ä½“æ•ˆæœ**

### æœ€ç»ˆï¼Œå¤–ç•Œè¯·æ±‚ï¼š

```bash
POST https://your-worker-subdomain.workers.dev/iap
Content-Type: application/json
{
  "appId": "6448311069",
  "slug": "chatgpt",
  "countries": ["us", "jp", "kr"]
}
```

```json
{
  "success": true,
  "data": {
    "us": {
      "success": true,
      "time_ms": 3452,
      "data": [
        { "name": "ChatGPT Plus", "price": "$19.99" },
        { "name": "ChatGPT Pro", "price": "$200.00" }
      ]
    },
    "jp": {
      "success": false,
      "time_ms": 30020,
      "error": "æŠ“å–è¶…æ—¶"
    },
    "kr": {
      "success": true,
      "time_ms": 2750,
      "data": [
        { "name": "ChatGPT Plus", "price": "â‚©29,000" },
        { "name": "ChatGPT Pro", "price": "â‚©299,000" }
      ]
    }
  }
}
```

âœ… Worker è½¬å‘åˆ°ä½ çš„ VPS çˆ¬è™«

âœ… Puppeteer å¯åŠ¨æµè§ˆå™¨æŸ¥å†…è´­

âœ… æŠ“åˆ°æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯

å…¨çƒè®¿é—®å¿«åˆ°é£èµ·ï¼Œè€Œä¸”ä½ çš„çœŸå® VPS IP å¯¹å¤–å®Œå…¨éšè—äº†ï¼

å¦‚æœæç¤ºæœåŠ¡å™¨ç³»ç»Ÿé‡Œç¼ºå°‘ Chrome å¿…é¡»ä¾èµ–çš„å…±äº«åº“

```
sudo apt update
sudo apt install -y \
  libnss3 \
  libatk-bridge2.0-0 \
  libcups2 \
  libx11-xcb1 \
  libxcomposite1 \
  libxdamage1 \
  libxrandr2 \
  libasound2 \
  libpangocairo-1.0-0 \
  libgtk-3-0

```

ç„¶åé‡æ–° reloadï¼š

```
pm2 reload fetchIAP-server

```
